<section>
  <h2>Build a Sandwich</h2>
  <nav>
    <a routerLink="/sandwiches">View sandwiches</a>
  </nav>
  <!-- Show a lightweight loading overlay instead of removing the form entirely
       This avoids the server-rendered form appearing and then disappearing
       during client bootstrap/hydration when `loading` toggles. -->
  <div *ngIf="loading" class="loading-overlay">Loading options…</div>

  <div *ngIf="!loading && (breadsError == 'Failed to load breads' && cheesesError == 'Failed to load cheeses' && dressingsError == 'Failed to load dressings' && meatsError == 'Failed to load meats' && toppingsError == 'Failed to load toppings')" class="warning">
    Options are unavailable right now. This usually means the backend options database isn't reachable. You can try again.
    <button (click)="retry()">Retry</button>
  </div>

  <!-- keep the form in the DOM while loading; add a dimmed state when loading -->
  <form (ngSubmit)="submit()" class="builder-form" [class.dimmed]="loading">
    <div class="grid">
      <div class="field" [class.invalid]="isInvalid('bread')">
        <label>Bread</label>
        <select [(ngModel)]="selected.breadId" name="bread">
          <option [ngValue]="null">-- choose --</option>
          <option *ngFor="let b of breads" [ngValue]="b.id">{{ b.label }}</option>
        </select>
        <div class="error" *ngIf="breadsError">{{ breadsError }} <button type="button" (click)="retryList('breads')">Retry</button></div>
      </div>

      <div class="field" [class.invalid]="isInvalid('cheese')">
        <label>Cheese (choose one or more)</label>
        <div class="checkbox-list">
          <div class="checkbox-item">
            <label>
              <input type="checkbox" [checked]="selected.noCheese" (change)="toggleNoCheese($event.target.checked)" />
              No Cheese
            </label>
          </div>
          <div class="checkbox-item" *ngFor="let c of cheeses">
            <label>
              <input type="checkbox" [checked]="selected.cheeseIds.includes(c.id)" (change)="toggleCheese(c.id, $event.target.checked)" />
              {{ c.label }}
            </label>
          </div>
        </div>
        <div class="error" *ngIf="cheesesError">{{ cheesesError }} <button type="button" (click)="retryList('cheeses')">Retry</button></div>
      </div>

      <div class="field" [class.invalid]="isInvalid('dressing')">
        <label>Dressing (choose one or more)</label>
        <div class="checkbox-list">
          <div class="checkbox-item">
            <label>
              <input type="checkbox" [checked]="selected.noDressing" (change)="toggleNoDressing($event.target.checked)" />
              No Dressing
            </label>
          </div>
          <div class="checkbox-item" *ngFor="let d of dressings">
            <label>
              <input type="checkbox" [checked]="selected.dressingIds.includes(d.id)" (change)="toggleDressing(d.id, $event.target.checked)" />
              {{ d.label }}
            </label>
          </div>
        </div>
        <div class="error" *ngIf="dressingsError">{{ dressingsError }} <button type="button" (click)="retryList('dressings')">Retry</button></div>
      </div>

      <div class="field" [class.invalid]="isInvalid('meat')">
        <label>Meat (choose one or more)</label>
        <div class="checkbox-list">
          <div class="checkbox-item">
            <label>
              <input type="checkbox" [checked]="selected.noMeat" (change)="toggleNoMeat($event.target.checked)" />
              No Meat
            </label>
          </div>
          <div class="checkbox-item" *ngFor="let m of meats">
            <label>
              <input type="checkbox" [checked]="selected.meatIds.includes(m.id)" (change)="toggleMeat(m.id, $event.target.checked)" />
              {{ m.label }}
            </label>
          </div>
        </div>
        <div class="error" *ngIf="meatsError">{{ meatsError }} <button type="button" (click)="retryList('meats')">Retry</button></div>
      </div>

      <div class="field" [class.invalid]="isInvalid('topping')">
        <label>Toppings</label>
        <div class="checkbox-list">
          <div class="checkbox-item">
            <label>
              <input type="checkbox" [checked]="selected.noToppings" (change)="toggleNoToppings($event.target.checked)" />
              No Toppings
            </label>
          </div>
          <div class="checkbox-item" *ngFor="let t of toppings">
            <label>
              <input type="checkbox" [checked]="selected.toppingIds.includes(t.id)" (change)="toggleTopping(t.id, $event.target.checked)" />
              {{ t.label }}
            </label>
          </div>
        </div>
        <div class="error" *ngIf="toppingsError">{{ toppingsError }} <button type="button" (click)="retryList('toppings')">Retry</button></div>
      </div>
    </div>

    <div class="actions">
      <div class="field" style="margin-right:12px;">
        <label>Name (optional)</label>
        <input type="text" [(ngModel)]="selected.name" name="name" placeholder="e.g. The Club" />
      </div>
      <div class="field" style="margin-right:12px;">
        <label>Price (optional)</label>
        <input type="number" step="0.01" min="0" [(ngModel)]="selected.price" name="price" placeholder="e.g. 7.50" />
      </div>
  <button class="btn btn-primary" type="submit" (click)="submit()" [disabled]="!canSubmit() || submitting">{{ submitting ? 'Saving…' : 'Submit' }}</button>
      <a routerLink="/sandwiches" class="link-to-list">Back to list</a>
    </div>
  </form>
  <div class="toast toast-success" *ngIf="success">
    {{ success }} <button type="button" (click)="clearMessages()">✕</button>
  </div>
  <div class="toast toast-error" *ngIf="error">
    {{ error }} <button type="button" (click)="clearMessages()">✕</button>
  </div>

  

  <!-- persistent save banner (accessible) -->
  <div class="save-banner" *ngIf="lastSave" role="status" aria-live="polite" tabindex="-1">
    <div [class.ok]="lastSave.ok" [class.err]="!lastSave.ok">
      <div class="icon" aria-hidden="true">{{ lastSave.ok ? '✓' : '!' }}</div>
      <div class="content">
        <div class="title"><strong>{{ lastSave.ok ? 'Saved' : 'Error' }}</strong></div>
        <div class="msg">{{ lastSave.message }}</div>
      </div>
      <button (click)="dismissLastSave()" class="dismiss" aria-label="Dismiss save notification">✕</button>
    </div>
    <!-- raw JSON removed to avoid showing internal data; keep a compact hint if needed -->
    <div *ngIf="lastSave.data" class="save-data-brief">Details available in developer tools</div>
  </div>
</section>
