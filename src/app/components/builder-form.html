<section>
  <!--<h2>Build a Sandwich</h2>-->
  <!-- Show a lightweight loading overlay instead of removing the form entirely
       This avoids the server-rendered form appearing and then disappearing
       during client bootstrap/hydration when `loading` toggles. -->
  <div *ngIf="loading" class="loading-overlay">Loading options…</div>

  <div *ngIf="!loading && (breadsError == 'Failed to load breads' && cheesesError == 'Failed to load cheeses' && dressingsError == 'Failed to load dressings' && meatsError == 'Failed to load meats' && toppingsError == 'Failed to load toppings')" class="warning">
    Options are unavailable right now. This usually means the backend options database isn't reachable. You can try again.
    <button (click)="retry()">Retry</button>
  </div>

  <!-- keep the form in the DOM while loading; add a dimmed state when loading -->
  <form (ngSubmit)="submit()" class="builder-form" [class.dimmed]="loading">
    <div class="simple-builder">
      <h3>{{ isEditMode ? 'Edit Sandwich' : 'Build a Sandwich' }}</h3>

      <div class="field">
        <label for="bread">Bread <span class="required">*</span></label>
        <select id="bread" [(ngModel)]="selected.breadId" name="bread" class="form-control" required>
          <option [ngValue]="null">-- choose bread --</option>
          <option *ngFor="let b of breads" [ngValue]="b.id">{{ b.label }}</option>
        </select>
        <div class="error" *ngIf="breadsError">{{ breadsError }} <button type="button" (click)="retryList('breads')">Retry</button></div>
      </div>

      <div class="field">
        <label for="toastedSwitch">Toasted</label>
        <label class="switch" for="toastedSwitch" role="switch" aria-checked="{{ selected.toasted }}">
          <input id="toastedSwitch" type="checkbox" [(ngModel)]="selected.toasted" name="toasted">
          <span class="slider"></span>
        </label>
      </div>

      <div class="compact-grid">
        <div class="field compact">
          <label>Cheese</label>
          <div class="checkbox-list compact">
            <label class="checkbox-item" *ngFor="let c of cheeses">
              <input type="checkbox" [checked]="selected.cheeseIds.includes(c.id)" (change)="toggleCheese(c.id, $event.target.checked)"> {{ c.label }}
            </label>
          </div>
          <label class="no-option">
            <input type="checkbox" [(ngModel)]="selected.noCheese" name="noCheese" (change)="toggleNoCheese($event.target.checked)"> No cheese
          </label>
          <div class="error" *ngIf="cheesesError">{{ cheesesError }} <button type="button" (click)="retryList('cheeses')">Retry</button></div>
        </div>

        <div class="field compact">
          <label>Dressing</label>
          <div class="checkbox-list compact">
            <label class="checkbox-item" *ngFor="let d of dressings">
              <input type="checkbox" [checked]="selected.dressingIds.includes(d.id)" (change)="toggleDressing(d.id, $event.target.checked)"> {{ d.label }}
            </label>
          </div>
          <label class="no-option">
            <input type="checkbox" [(ngModel)]="selected.noDressing" name="noDressing" (change)="toggleNoDressing($event.target.checked)"> No dressing
          </label>
          <div class="error" *ngIf="dressingsError">{{ dressingsError }} <button type="button" (click)="retryList('dressings')">Retry</button></div>
        </div>

        <div class="field compact">
          <label>Meat</label>
          <div class="checkbox-list compact">
            <label class="checkbox-item" *ngFor="let m of meats">
              <input type="checkbox" [checked]="selected.meatIds.includes(m.id)" (change)="toggleMeat(m.id, $event.target.checked)"> {{ m.label }}
            </label>
          </div>
          <label class="no-option">
            <input type="checkbox" [(ngModel)]="selected.noMeat" name="noMeat" (change)="toggleNoMeat($event.target.checked)"> No meat
          </label>
          <div class="error" *ngIf="meatsError">{{ meatsError }} <button type="button" (click)="retryList('meats')">Retry</button></div>
        </div>

        <div class="field compact">
          <label>Toppings</label>
          <div class="checkbox-list compact">
            <label class="checkbox-item" *ngFor="let t of toppings">
              <input type="checkbox" [checked]="selected.toppingIds.includes(t.id)" (change)="toggleTopping(t.id, $event.target.checked)"> {{ t.label }}
            </label>
          </div>
          <label class="no-option">
            <input type="checkbox" [(ngModel)]="selected.noToppings" name="noToppings" (change)="toggleNoToppings($event.target.checked)"> No toppings
          </label>
          <div class="error" *ngIf="toppingsError">{{ toppingsError }} <button type="button" (click)="retryList('toppings')">Retry</button></div>
        </div>
      </div>

      <div class="field">
        <label for="name">Name <span class="required">*</span></label>
        <input id="name" type="text" [(ngModel)]="selected.name" name="name" placeholder="e.g. The Club" required />
        <div class="error" *ngIf="touchedOnSubmit && (!selected.name || (selected.name && selected.name.trim().length === 0))">Name is required</div>
      </div>

      <div class="field">
        <label for="price">Price (optional)</label>
        <input id="price" type="number" step="0.01" min="0" [(ngModel)]="selected.price" name="price" placeholder="e.g. 7.50" />
      </div>

      <div class="actions">
        <button type="submit" class="btn btn-primary" [disabled]="submitting || !selected.breadId">{{ submitting ? 'Saving…' : (isEditMode ? 'Save' : 'Create') }}</button>
        <button type="button" class="btn btn-outline-secondary" (click)="cancelEdit()">Cancel</button>
        <a routerLink="/sandwiches" class="link-to-list">Back to list</a>
      </div>
    </div>
  </form>
  <div class="toast toast-success" *ngIf="success">
    {{ success }} <button type="button" (click)="clearMessages()">✕</button>
  </div>
  <div class="toast toast-error" *ngIf="error">
    {{ error }} <button type="button" (click)="clearMessages()">✕</button>
  </div>

  

  <!-- persistent save banner (accessible) -->
  <div class="save-banner" *ngIf="lastSave" role="status" aria-live="polite" tabindex="-1">
    <div [class.ok]="lastSave.ok" [class.err]="!lastSave.ok">
      <div class="icon" aria-hidden="true">{{ lastSave.ok ? '✓' : '!' }}</div>
      <div class="content">
        <div class="title"><strong>{{ lastSave.ok ? 'Saved' : 'Error' }}</strong></div>
        <div class="msg">{{ lastSave.message }}</div>
      </div>
      <button (click)="dismissLastSave()" class="dismiss" aria-label="Dismiss save notification">✕</button>
    </div>
    <!-- raw JSON removed to avoid showing internal data; keep a compact hint if needed -->
    <div *ngIf="lastSave.data" class="save-data-brief">Details available in developer tools</div>
  </div>
</section>
